name: Auto Healing Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
        - name: Detect problems and auto-heal
      id: heal
      run: |
        echo "ðŸ” Starting Auto-Healing Diagnostic Scan..."
        
        # Initialize healing flag
        NEEDS_COMMIT="false"
        
        # Healing Layer 1: Remove problematic files
        if [ -f "broken.txt" ]; then
          echo "ðŸš‘ HEALING: Removing broken.txt file"
          rm broken.txt
          NEEDS_COMMIT="true"
        fi
        
        # Healing Layer 2: Fix Python syntax issues
        if [ -f "src/app.py" ]; then
          echo "ðŸ”§ Checking Python code health..."
          if python -m py_compile src/app.py; then
            echo "âœ… Python syntax is valid"
          else
            echo "ðŸš‘ HEALING: Fixing Python syntax issues"
            # Fix common Python errors with better pattern matching
            sed -i 's/printx(/print(/g' src/app.py 2>/dev/null || true
            sed -i 's/print \(/print(/g' src/app.py 2>/dev/null || true
            sed -i 's/importx flask/import flask/g' src/app.py 2>/dev/null || true
            sed -i "s/''''/'/g" src/app.py 2>/dev/null || true
            
            # Test if fixes worked
            if python -m py_compile src/app.py; then
              echo "âœ… Python syntax fixed successfully"
              NEEDS_COMMIT="true"
            else
              echo "âŒ Could not auto-fix Python syntax"
              exit 1
            fi
          fi
        fi
        
        # Healing Layer 3: Fix missing requirements
        if [ ! -f "requirements.txt" ]; then
          echo "ðŸš‘ HEALING: Creating missing requirements.txt"
          echo "flask==2.3.3" > requirements.txt
          echo "requests==2.31.0" >> requirements.txt
          NEEDS_COMMIT="true"
        fi
        
        # Set output if healing occurred
        if [ "$NEEDS_COMMIT" = "true" ]; then
          echo "needs_commit=true" >> $GITHUB_OUTPUT
          echo "ðŸ’Š Auto-healing treatments applied"
        else
          echo "âœ… No healing needed - system is healthy"
        fi
        
    - name: Commit fixes if needed
      if: steps.heal.outputs.needs_commit == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ðŸ¤– Auto-heal: Fixed issues detected in pipeline"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
    - name: Install dependencies
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        
    - name: Run tests
      run: |
        echo "ðŸ§ª Running test suite..."
        # Windows-friendly: no chmod needed
        bash tests/test_script.sh
        
    - name: Final status
      run: |
        echo "ðŸŽ‰ PIPELINE STATUS: SUCCESS"
        echo "ðŸ’š System is healthy and operational"
        echo "ðŸ¤– Auto-healing: ACTIVE"
        echo "ðŸ“Š All validation checks: PASSED"